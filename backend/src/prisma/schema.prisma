// ============================================
// SISTEMA DE COTIZACIONES Y COMPRAS
// Prisma Schema - ACTUALIZADO
// ============================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
  log             = ["query"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CATÁLOGOS BASE
// ============================================

model Area {
  id         String     @id @default(uuid()) @db.Uuid
  nombreArea String     @unique @map("nombre_area")
  tipo       String // "proyectos" | "comercial" | "tecnica" | "operativa"
  icono      String?
  creado     DateTime   @default(now())
  proyectos  Proyecto[]

  tipos Tipo[]

  @@index([tipo])
  @@map("area")
}

// ============================================
// CATÁLOGOS DE TIPOS
// ============================================

model Tipo {
  id     String   @id @default(uuid()) @db.Uuid
  areaId String   @map("area_id") @db.Uuid
  nombre String
  creado DateTime @default(now())

  area         Area         @relation(fields: [areaId], references: [id], onDelete: Restrict)
  cotizaciones Cotizacion[]

  @@unique([areaId, nombre])
  @@index([areaId])
  @@map("tipo")
}

// ============================================
// CATÁLOGOS DE DEPARTAMENTOS
// ============================================

model Departamento {
  id     String   @id @default(uuid()) @db.Uuid
  nombre String   @unique
  creado DateTime @default(now())

  usuarios Usuario[]

  @@map("departamento")
}

// ============================================
// CATÁLOGOS DE PROYECTOS
// ============================================

model Proyecto {
  id          String   @id @default(uuid()) @db.Uuid
  nombre      String   @unique
  descripcion String?
  criticidad  Int      @default(5) // 1-10, donde 10 es más crítico
  estado      Boolean  @default(true)
  creado      DateTime @default(now())
  actualizado DateTime @default(now()) @updatedAt
  areaId      String?  @map("area_id") @db.Uuid

  area Area? @relation(fields: [areaId], references: [id], onDelete: SetNull)

  cotizaciones     Cotizacion[]
  estadosProductos EstadoProducto[]

  @@index([criticidad])
  @@index([estado])
  @@map("proyecto")
}

// ============================================
// CATÁLOGOS DE PROVEEDORES
// ============================================

model Proveedor {
  id        String   @id @default(uuid()) @db.Uuid
  nombre    String   @unique
  rtn       String?
  email     String?
  telefono  String?
  direccion String?
  activo    Boolean  @default(true)
  creado    DateTime @default(now())

  precios        Precios[]
  compraDetalles CompraDetalle[]

  @@index([activo])
  @@map("proveedor")
}

// ============================================
// USUARIOS Y PERMISOS
// ============================================

model Rol {
  id          String    @id @default(uuid()) @db.Uuid
  nombre      String    @unique
  descripcion String
  activo      Boolean   @default(true)
  creado      DateTime  @default(now())
  actualizado DateTime? @default(now())

  usuarios    Usuario[]
  rolPermisos RolPermisos[]

  @@map("rol")
}

model Permisos {
  id          String   @id @default(uuid()) @db.Uuid
  modulo      String
  accion      String
  descripcion String?
  activo      Boolean  @default(true)
  creado      DateTime @default(now())

  rolPermisos RolPermisos[]

  @@unique([modulo, accion])
  @@index([modulo])
  @@index([accion])
  @@map("permisos")
}

model RolPermisos {
  rolId     String   @map("rol_id") @db.Uuid
  permisoId String   @map("permiso_id") @db.Uuid
  creado    DateTime @default(now())

  rol     Rol      @relation(fields: [rolId], references: [id], onDelete: Cascade)
  permiso Permisos @relation(fields: [permisoId], references: [id], onDelete: Cascade)

  @@id([rolId, permisoId])
  @@index([rolId])
  @@index([permisoId])
  @@map("rol_permisos")
}

model Usuario {
  id                     String    @id @default(uuid()) @db.Uuid
  nombre                 String
  email                  String    @unique
  passwordHash           String    @map("password_hash")
  rolId                  String    @map("rol_id") @db.Uuid
  departamentoId         String    @map("departamento_id") @db.Uuid
  activo                 Boolean   @default(true)
  creado                 DateTime  @default(now())
  actualizado            DateTime? @default(now())
  requierecambiopassword Boolean   @default(false) @map("requierecambiopassword")

  rol          Rol          @relation(fields: [rolId], references: [id], onDelete: Restrict)
  departamento Departamento @relation(fields: [departamentoId], references: [id], onDelete: Restrict)

  cotizaciones             Cotizacion[]            @relation("UsuarioSolicitante")
  seguimientos             Seguimiento[]
  mensajes                 Mensaje[]
  notificaciones           Notificacion[]
  participantesChat        ParticipantesChat[]
  cotizacionesSupervisadas Cotizacion[]            @relation("SupervisorCotizacion")
  historialCotizaciones    HistorialCotizacion[]
  sesiones                 Sesion[]
  historialFechasCreadas   HistorialFechaLimite[]  @relation("HistorialFechaCreadoPor")
  documentosSubidos        DocumentoAdjunto[]      @relation("DocumentosSubidos")
  justificacionesCreadoPor JustificacionNoAplica[] @relation("JustificacionesCreadoPor")
  aprobacionesCompra       EstadoProducto[]        @relation("AprobadorCompra")
  seguimientosAsignados    EstadoProducto[]        @relation("ResponsableSeguimiento")

  @@index([email])
  @@index([rolId])
  @@index([activo])
  @@map("usuario")
}

// ============================================
// DOCUMENTOS REQUERIDOS POR ESTADO (CONFIG GLOBAL)
// ============================================

model DocumentoRequerido {
  id          String   @id @default(uuid()) @db.Uuid
  estado      String   @db.VarChar(50) // "comprado", "pagado", etc.
  nombre      String   @db.VarChar(150) // "Orden de Compra"
  descripcion String?  @db.Text
  obligatorio Boolean  @default(true)
  orden       Int      @default(0)
  activo      Boolean  @default(true)
  creado      DateTime @default(now())
  actualizado DateTime @default(now()) @updatedAt

  documentosAdjuntos DocumentoAdjunto[]

  @@unique([estado, nombre])
  @@index([estado])
  @@index([activo])
  @@map("documento_requerido")
}

// ============================================
// DOCUMENTOS ADJUNTOS (ARCHIVOS REALES)
// ============================================

model DocumentoAdjunto {
  id                   String   @id @default(uuid()) @db.Uuid
  estadoProductoId     String   @map("estado_producto_id") @db.Uuid
  documentoRequeridoId String?  @map("documento_requerido_id") @db.Uuid
  estado               String   @db.VarChar(50)
  nombreDocumento      String   @map("nombre_documento") @db.VarChar(255)
  nombreArchivo        String   @map("nombre_archivo") @db.VarChar(255)
  urlArchivo           String   @map("url_archivo") @db.Text
  tipoArchivo          String?  @map("tipo_archivo") @db.VarChar(50)
  tamanoBytes          BigInt?  @map("tamano_bytes")
  subidoPorId          String   @map("subido_por") @db.Uuid
  creado               DateTime @default(now())
  noAplica             Boolean  @default(false) @map("no_aplica")

  estadoProducto     EstadoProducto      @relation(fields: [estadoProductoId], references: [id], onDelete: Cascade)
  documentoRequerido DocumentoRequerido? @relation(fields: [documentoRequeridoId], references: [id], onDelete: SetNull)
  subidoPor          Usuario             @relation("DocumentosSubidos", fields: [subidoPorId], references: [id], onDelete: Restrict)

  @@index([estadoProductoId])
  @@index([documentoRequeridoId])
  @@index([estado])
  @@index([subidoPorId])
  @@map("documento_adjunto")
}

model JustificacionNoAplica {
  id               String   @id @default(uuid()) @db.Uuid
  estadoProductoId String   @map("estado_producto_id") @db.Uuid
  estado           String   @db.VarChar(50)
  justificacion    String   @db.Text
  creadoPorId      String   @map("creado_por") @db.Uuid
  creado           DateTime @default(now())
  actualizado      DateTime @default(now()) @updatedAt

  estadoProducto EstadoProducto @relation(fields: [estadoProductoId], references: [id], onDelete: Cascade)
  creadoPor      Usuario        @relation("JustificacionesCreadoPor", fields: [creadoPorId], references: [id], onDelete: Restrict)

  @@unique([estadoProductoId, estado])
  @@index([estadoProductoId])
  @@index([estado])
  @@map("justificacion_no_aplica")
}

// ============================================
// PROCESO DE COTIZACIÓN
// ============================================

model Cotizacion {
  id               String   @id @default(uuid()) @db.Uuid
  tipoCompra       String   @default("NACIONAL") @map("tipo_compra")
  tipoId           String   @map("tipo_id") @db.Uuid
  solicitanteId    String   @map("solicitante_id") @db.Uuid
  lugarEntrega     String   @default("ALMACEN") @map("lugar_entrega")
  comentarios      String?
  fechaSolicitud   DateTime @default(now()) @map("fecha_solicitud")
  fechaLimite      DateTime @map("fecha_limite")
  estado           String   @default("PENDIENTE") // ← CAMBIAR default de "ENVIADA" a "PENDIENTE"
  nombreCotizacion String   @map("nombre_cotizacion")
  proyectoId       String?  @map("proyecto_id") @db.Uuid
  fechaEstimada    DateTime @map("fecha_estimada")

  // ========================================
  // NUEVOS CAMPOS
  // ========================================
  supervisorResponsableId String?   @map("supervisor_responsable_id") @db.Uuid
  chatId                  String?   @unique @map("chat_id") @db.Uuid
  aprobadaParcialmente    Boolean   @default(false) @map("aprobada_parcialmente")
  todosProductosAprobados Boolean   @default(false) @map("todos_productos_aprobados")
  fechaAprobacion         DateTime? @map("fecha_aprobacion")

  // Relaciones existentes
  tipo        Tipo      @relation(fields: [tipoId], references: [id], onDelete: Restrict)
  solicitante Usuario   @relation("UsuarioSolicitante", fields: [solicitanteId], references: [id], onDelete: Restrict)
  proyecto    Proyecto? @relation(fields: [proyectoId], references: [id], onDelete: SetNull)

  // ========================================
  // NUEVAS RELACIONES
  // ========================================
  supervisorResponsable Usuario?              @relation("SupervisorCotizacion", fields: [supervisorResponsableId], references: [id], onDelete: SetNull)
  chat                  Chat?                 @relation(fields: [chatId], references: [id], onDelete: SetNull)
  historial             HistorialCotizacion[]

  // Relaciones existentes
  detalles         CotizacionDetalle[]
  compras          Compra[]
  estadosProductos EstadoProducto[]

  @@index([solicitanteId])
  @@index([estado])
  @@index([proyectoId])
  @@index([fechaSolicitud])
  @@index([supervisorResponsableId]) // ← NUEVO
  @@index([chatId]) // ← NUEVO
  @@map("cotizacion")
}

model CotizacionDetalle {
  id                  String  @id @default(uuid()) @db.Uuid
  cotizacionId        String  @map("cotizacion_id") @db.Uuid
  sku                 String?
  descripcionProducto String  @map("descripcion_producto")
  cantidad            Int
  tipoUnidad          String  @map("tipo_unidad")
  notas               String?
  preciosId           String? @map("precios_id") @db.Uuid

  cotizacion Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  precios    Precios?   @relation("PrecioSeleccionado", fields: [preciosId], references: [id], onDelete: SetNull)

  preciosOfertas   Precios[]        @relation("PreciosPorDetalle")
  estadosProductos EstadoProducto[]

  @@index([cotizacionId])
  @@index([sku])
  @@map("cotizacion_detalle")
}

model Pais {
  id     String  @id @default(uuid()) @db.Uuid
  nombre String  @unique @db.VarChar(100) // "China", "USA", "México"
  codigo String  @unique @db.VarChar(3) // "CN", "US", "MX"
  activo Boolean @default(true)

  creado      DateTime @default(now())
  actualizado DateTime @default(now()) @updatedAt

  // Relaciones
  estadosProductos EstadoProducto[]
  timelinesSKU     TimelineSKU[]

  @@index([activo])
  @@map("pais")
}

model TimelineSKU {
  id  String @id @default(uuid()) @db.Uuid
  sku String @db.VarChar(255) // SKU del producto

  // País y transporte default para este SKU
  paisOrigenId    String?         @db.Uuid
  paisOrigen      Pais?           @relation(fields: [paisOrigenId], references: [id])
  medioTransporte MedioTransporte @default(MARITIMO)

  // Timeline de días entre procesos (null = proceso no aplica para este SKU)
  diasCotizadoADescuento            Int? // null si no pasa por descuento
  diasDescuentoAAprobacionCompra    Int? // ← NUEVO
  diasAprobacionCompraAComprado     Int? // ← NUEVO
  diasDescuentoAComprado            Int? // mantener para compatibilidad
  diasCompradoAPagado               Int?
  diasPagadoAAprobacionPlanos       Int? // ← NUEVO
  diasAprobacionPlanosASeguimiento1 Int? // ← NUEVO
  diasPagadoASeguimiento1           Int? // mantener para compatibilidad
  diasSeguimiento1AFob              Int? // null si no es importación
  diasFobACotizacionFlete           Int?
  diasCotizacionFleteABl            Int?
  diasFobABl                        Int? // mantener para compatibilidad
  diasBlASeguimiento2               Int?
  diasSeguimiento2ACif              Int? // null si no es importación
  diasCifARecibido                  Int?

  // Total calculado (solo suma los que no son null)
  diasTotalesEstimados Int

  // Observaciones
  notas String? @db.Text

  creado      DateTime @default(now())
  actualizado DateTime @default(now()) @updatedAt

  @@unique([sku]) // Un timeline por SKU
  @@index([sku])
  @@index([paisOrigenId])
  @@map("timeline_sku")
}

enum MedioTransporte {
  MARITIMO
  TERRESTRE
  AEREO

  @@map("medio_transporte")
}

enum EstadoCotizacion {
  PENDIENTE // Recién creada, esperando configuración supervisor
  EN_CONFIGURACION // Supervisor está configurando timeline
  APROBADA_PARCIAL // Algunos productos aprobados
  APROBADA_COMPLETA // Todos los productos aprobados
  EN_PROCESO // En proceso de compra
  COMPLETADA // Todos los productos recibidos
  CANCELADA // Cancelada

  @@map("estado_cotizacion")
}

// Y actualizar campo estado en Cotizacion:
// estado EstadoCotizacion @default(PENDIENTE)

model Precios {
  id                   String   @id @default(uuid()) @db.Uuid
  cotizacionDetalleId  String   @map("cotizacion_detalle_id") @db.Uuid
  precio               Decimal  @db.Decimal(15, 4)
  precioDescuento      Decimal? @map("precio_descuento") @db.Decimal(15, 4)
  proveedorId          String   @map("proveedor_id") @db.Uuid
  fechaConsulta        DateTime @default(now()) @map("fecha_consulta")
  ComprobanteDescuento String?  @map("comprobante_descuento")

  cotizacionDetalle CotizacionDetalle @relation("PreciosPorDetalle", fields: [cotizacionDetalleId], references: [id], onDelete: Cascade)
  proveedor         Proveedor         @relation(fields: [proveedorId], references: [id], onDelete: Restrict)

  cotizacionDetalleSeleccionado CotizacionDetalle[] @relation("PrecioSeleccionado")

  @@index([cotizacionDetalleId])
  @@index([proveedorId])
  @@map("precios")
}

// ============================================
// PROCESO DE COMPRA
// ============================================

model Compra {
  id           String   @id @default(uuid()) @db.Uuid
  cotizacionId String   @map("cotizacion_id") @db.Uuid
  estado       String   @default("PENDIENTE")
  creacion     DateTime @default(now())
  actualizado  DateTime @default(now()) @updatedAt

  cotizacion Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Restrict)

  detalles         CompraDetalle[]
  seguimientos     Seguimiento[]    @relation("SeguimientoCompra")
  estadosProductos EstadoProducto[]

  @@index([cotizacionId])
  @@index([estado])
  @@map("compra")
}

model CompraDetalle {
  id                       String    @id @default(uuid()) @db.Uuid
  compraId                 String    @map("compra_id") @db.Uuid
  sku                      String?
  descripcionProducto      String    @map("descripcion_producto")
  cantidad                 Int
  tipoUnidad               String    @map("tipo_unidad")
  notas                    String?
  precio                   Decimal   @db.Decimal(15, 4)
  proveedorId              String    @map("proveedor_id") @db.Uuid
  estado                   String    @default("PRE-COMPRA")
  fechaCompra              DateTime? @map("fecha_compra")
  fechaFabricacion         DateTime? @map("fecha_fabricacion")
  fechaFors                DateTime? @map("fecha_fors")
  fechaCif                 DateTime? @map("fecha_cif")
  fechaRecibido            DateTime? @map("fecha_recibido")
  fechaUltimaActualizacion DateTime  @default(now()) @updatedAt @map("fecha_ultima_actualizacion")

  compra    Compra    @relation(fields: [compraId], references: [id], onDelete: Cascade)
  proveedor Proveedor @relation(fields: [proveedorId], references: [id], onDelete: Restrict)

  seguimientos     Seguimiento[]    @relation("SeguimientoCompraDetalle")
  estadosProductos EstadoProducto[]

  @@index([compraId])
  @@index([proveedorId])
  @@index([estado])
  @@index([sku])
  @@map("compra_detalle")
}

// ============================================
// NUEVA TABLA: ESTADOS Y SEGUIMIENTO DE PRODUCTOS
// ============================================

model EstadoProducto {
  id String @id @default(uuid()) @db.Uuid

  // Referencias flexibles
  proyectoId          String? @db.Uuid
  cotizacionId        String? @db.Uuid
  cotizacionDetalleId String? @db.Uuid
  compraId            String? @db.Uuid
  compraDetalleId     String? @db.Uuid

  // Identificación
  sku         String @db.VarChar(255)
  descripcion String @db.Text

  // ========================================
  // NUEVOS CAMPOS - País y Transporte
  // ========================================
  paisOrigenId    String?          @db.Uuid
  paisOrigen      Pais?            @relation(fields: [paisOrigenId], references: [id])
  medioTransporte MedioTransporte?

  // ========================================
  // 10 estados booleanos
  // ========================================
  cotizado                     Boolean @default(false)
  conDescuento                 Boolean @default(false)
  aprobacionCompra             Boolean @default(false)
  comprado                     Boolean @default(false)
  pagado                       Boolean @default(false)
  aprobacionPlanos             Boolean @default(false)
  primerSeguimiento            Boolean @default(false)
  enFOB                        Boolean @default(false)
  cotizacionFleteInternacional Boolean @default(false)
  conBL                        Boolean @default(false)
  segundoSeguimiento           Boolean @default(false)
  enCIF                        Boolean @default(false)
  recibido                     Boolean @default(false)

  // ========================================
  // 10 fechas para tracking temporal
  // ========================================
  fechaCotizado                     DateTime?
  fechaConDescuento                 DateTime?
  fechaAprobacionCompra             DateTime?
  fechaComprado                     DateTime?
  fechaPagado                       DateTime?
  fechaAprobacionPlanos             DateTime?
  fechaPrimerSeguimiento            DateTime?
  fechaEnFOB                        DateTime?
  fechaCotizacionFleteInternacional DateTime?
  fechaConBL                        DateTime?
  fechaSegundoSeguimiento           DateTime?
  fechaEnCIF                        DateTime?
  fechaRecibido                     DateTime?

  // ========================================
  // NUEVOS CAMPOS - Fechas límite por proceso
  // ========================================
  // Estas se calculan automáticamente desde el timeline del SKU
  fechaLimiteCotizado                     DateTime?
  fechaLimiteConDescuento                 DateTime?
  fechaLimiteAprobacionCompra             DateTime?
  fechaLimiteComprado                     DateTime?
  fechaLimitePagado                       DateTime?
  fechaLimiteAprobacionPlanos             DateTime?
  fechaLimitePrimerSeguimiento            DateTime?
  fechaLimiteEnFOB                        DateTime?
  fechaLimiteCotizacionFleteInternacional DateTime?
  fechaLimiteConBL                        DateTime?
  fechaLimiteSegundoSeguimiento           DateTime?
  fechaLimiteEnCIF                        DateTime?
  fechaLimiteRecibido                     DateTime?

  // ========================================
  // Fechas Reales (editables por supervisor)
  // Se inicializan con el valor de la fecha base
  // ========================================
  fechaRealAprobacionCompra             DateTime?
  fechaRealComprado                     DateTime?
  fechaRealPagado                       DateTime?
  fechaRealAprobacionPlanos             DateTime?
  fechaRealPrimerSeguimiento            DateTime?
  fechaRealEnFOB                        DateTime?
  fechaRealCotizacionFleteInternacional DateTime?
  fechaRealConBL                        DateTime?
  fechaRealSegundoSeguimiento           DateTime?
  fechaRealEnCIF                        DateTime?
  fechaRealRecibido                     DateTime?

  // ========================================
  // CÁLCULOS DE RETRASO Y CRITICIDAD
  // ========================================
  diasRetrasoActual Int    @default(0) // Días de retraso en el proceso actual
  criticidad        Int    @default(5) // 1-10, calculado automáticamente
  nivelCriticidad   String @default("MEDIO") // "BAJO", "MEDIO", "ALTO"

  // Info adicional
  proveedor      String?  @db.VarChar(255)
  responsable    String?  @db.VarChar(255)
  precioUnitario Decimal? @db.Decimal(15, 4)
  precioTotal    Decimal? @db.Decimal(15, 4)
  cantidad       Int?
  observaciones  String?  @db.Text
  estadoGeneral  String   @default("warn") @db.VarChar(20) // "success", "warn", "danger"

  // Metadata
  creado      DateTime @default(now())
  actualizado DateTime @default(now()) @updatedAt

  // NUEVOS CAMPOS - Rechazo de productos
  rechazado     Boolean   @default(false)
  fechaRechazo  DateTime? @map("fecha_rechazo")
  motivoRechazo String?   @map("motivo_rechazo") @db.Text

  evidenciaCotizado                     String? @db.Text
  evidenciaConDescuento                 String? @db.Text
  evidenciaAprobacionCompra             String? @db.Text
  evidenciaComprado                     String? @db.Text
  evidenciaPagado                       String? @db.Text
  evidenciaAprobacionPlanos             String? @db.Text
  evidenciaPrimerSeguimiento            String? @db.Text
  evidenciaEnFOB                        String? @db.Text
  evidenciaCotizacionFleteInternacional String? @db.Text
  evidenciaConBL                        String? @db.Text
  evidenciaSegundoSeguimiento           String? @db.Text
  evidenciaEnCIF                        String? @db.Text
  evidenciaRecibido                     String? @db.Text

  // Relaciones
  proyecto                 Proyecto?          @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  cotizacion               Cotizacion?        @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  cotizacionDetalle        CotizacionDetalle? @relation(fields: [cotizacionDetalleId], references: [id], onDelete: Cascade)
  compra                   Compra?            @relation(fields: [compraId], references: [id], onDelete: Cascade)
  compraDetalle            CompraDetalle?     @relation(fields: [compraDetalleId], references: [id], onDelete: Cascade)
  aprobadoPorSupervisor    Boolean            @default(false) @map("aprobado_por_supervisor")
  fechaAprobacion          DateTime?          @map("fecha_aprobacion")
  tipoEntrega              String?            @map("tipo_entrega") @db.VarChar(20) // Incoterms: EXW, FOB, FCA, CIF, CIP, CPT, CPR, DAP, DDP
  aprobadoCompra           Boolean            @default(false) @map("aprobado_compra")
  aprobadoCompraPorId      String?            @map("aprobado_compra_por_id") @db.Uuid
  fechaAprobadoCompra      DateTime?          @map("fecha_aprobado_compra")
  aprobadoCompraPor        Usuario?           @relation("AprobadorCompra", fields: [aprobadoCompraPorId], references: [id], onDelete: SetNull)
  responsableSeguimientoId String?            @map("responsable_seguimiento_id") @db.Uuid
  responsableSeguimiento   Usuario?           @relation("ResponsableSeguimiento", fields: [responsableSeguimientoId], references: [id], onDelete: SetNull)

  // Documentos adjuntos
  documentosAdjuntos      DocumentoAdjunto[]
  justificacionesNoAplica JustificacionNoAplica[]

  // No aplica documentos por estado
  noAplicaDocumentosAprobacionCompra             Boolean                @default(false)
  noAplicaDocumentosComprado                     Boolean                @default(false)
  noAplicaDocumentosPagado                       Boolean                @default(false)
  noAplicaDocumentosAprobacionPlanos             Boolean                @default(false)
  noAplicaDocumentosPrimerSeguimiento            Boolean                @default(false)
  noAplicaDocumentosEnFOB                        Boolean                @default(false)
  noAplicaDocumentosCotizacionFleteInternacional Boolean                @default(false)
  noAplicaDocumentosConBL                        Boolean                @default(false)
  noAplicaDocumentosSegundoSeguimiento           Boolean                @default(false)
  noAplicaDocumentosEnCIF                        Boolean                @default(false)
  noAplicaDocumentosRecibido                     Boolean                @default(false)
  // Relación con historial
  historialFechas                                HistorialFechaLimite[]

  @@index([proyectoId])
  @@index([cotizacionId])
  @@index([sku])
  @@index([criticidad])
  @@index([nivelCriticidad])
  @@index([paisOrigenId])
  @@index([medioTransporte])
  @@map("estado_producto")
}

// ============================================
// HISTORIAL DE CAMBIOS EN FECHAS REALES
// ============================================

model HistorialFechaLimite {
  id               String    @id @default(uuid()) @db.Uuid
  estadoProductoId String    @map("estado_producto_id") @db.Uuid
  estado           String    @db.VarChar(50) // "aprobacionCompra", "comprado", etc.
  fechaAnterior    DateTime?
  fechaNueva       DateTime
  creadoPorId      String    @map("creado_por") @db.Uuid
  creado           DateTime  @default(now())

  estadoProducto EstadoProducto @relation(fields: [estadoProductoId], references: [id], onDelete: Cascade)
  creadoPor      Usuario        @relation("HistorialFechaCreadoPor", fields: [creadoPorId], references: [id], onDelete: Restrict)

  @@index([estadoProductoId])
  @@index([estado])
  @@index([creado])
  @@index([creadoPorId])
  @@map("historial_fecha_limite")
}

model ProcesoPersonalizado {
  id            String  @id @default(uuid()) @db.Uuid
  nombre        String  @db.VarChar(100) // "Inspección de Calidad"
  codigo        String  @unique @db.VarChar(50) // "INSPECCION_CALIDAD"
  orden         Int // Posición en el flujo (1, 2, 3...)
  esObligatorio Boolean @default(false)
  descripcion   String? @db.Text
  activo        Boolean @default(true)

  creado      DateTime @default(now())
  actualizado DateTime @default(now()) @updatedAt

  @@index([activo])
  @@index([orden])
  @@map("proceso_personalizado")
}

// ============================================
// SEGUIMIENTO
// ============================================

model Seguimiento {
  id              String   @id @default(uuid()) @db.Uuid
  compraId        String?  @map("compra_id") @db.Uuid
  compraDetalleId String?  @map("compra_detalle_id") @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  tipo            String
  detalle         String
  fecha           DateTime @default(now())

  compra        Compra?        @relation("SeguimientoCompra", fields: [compraId], references: [id], onDelete: Cascade)
  compraDetalle CompraDetalle? @relation("SeguimientoCompraDetalle", fields: [compraDetalleId], references: [id], onDelete: Cascade)
  usuario       Usuario        @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([compraId])
  @@index([compraDetalleId])
  @@index([userId])
  @@index([fecha])
  @@map("seguimiento")
}

// ============================================
// MENSAJERÍA
// ============================================

model Chat {
  id          String   @id @default(uuid()) @db.Uuid
  creado      DateTime @default(now())
  actualizado DateTime @default(now()) @updatedAt

  participantes ParticipantesChat[]
  mensajes      Mensaje[]

  // ========================================
  // NUEVA RELACIÓN
  // ========================================
  cotizacion Cotizacion? // ← Relación inversa uno-a-uno

  @@map("chat")
}

model HistorialCotizacion {
  id           String   @id @default(uuid()) @db.Uuid
  cotizacionId String   @map("cotizacion_id") @db.Uuid
  usuarioId    String   @map("usuario_id") @db.Uuid
  accion       String // "TIMELINE_CONFIGURADO", "PAIS_MODIFICADO", "APROBADO_PARCIAL", "APROBADO_TOTAL"
  detalles     Json // { sku?, productoId?, campoModificado, valorAnterior, valorNuevo }
  creado       DateTime @default(now())

  cotizacion Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  usuario    Usuario    @relation(fields: [usuarioId], references: [id], onDelete: Restrict)

  @@index([cotizacionId])
  @@index([usuarioId])
  @@index([creado])
  @@map("historial_cotizacion")
}

model ParticipantesChat {
  chatId      String    @map("chat_id") @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  ultimoLeido DateTime? @map("ultimo_leido")

  chat    Chat    @relation(fields: [chatId], references: [id], onDelete: Cascade)
  usuario Usuario @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([chatId, userId])
  @@index([chatId])
  @@index([userId])
  @@map("participantes_chat")
}

model Mensaje {
  id          String   @id @default(uuid()) @db.Uuid
  chatId      String   @map("chat_id") @db.Uuid
  emisorId    String   @map("emisor_id") @db.Uuid
  contenido   String
  tipoMensaje String   @default("TEXTO") @map("tipo_mensaje")
  creado      DateTime @default(now())

  chat   Chat    @relation(fields: [chatId], references: [id], onDelete: Cascade)
  emisor Usuario @relation(fields: [emisorId], references: [id], onDelete: Restrict)

  adjuntos Adjuntos[]

  @@index([chatId])
  @@index([emisorId])
  @@index([creado])
  @@map("mensaje")
}

model Adjuntos {
  id               String   @id @default(uuid()) @db.Uuid
  mensajeId        String   @map("mensaje_id") @db.Uuid
  direccionArchivo String   @map("direccion_archivo")
  tipoArchivo      String   @map("tipo_archivo")
  tamanio          BigInt
  creado           DateTime @default(now())

  mensaje Mensaje @relation(fields: [mensajeId], references: [id], onDelete: Cascade)

  @@index([mensajeId])
  @@map("adjuntos")
}

// ============================================
// NOTIFICACIONES
// ============================================

model Notificacion {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  tipo        String
  titulo      String
  descripcion String
  creada      DateTime @default(now())
  completada  Boolean  @default(false)

  usuario Usuario @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([completada])
  @@index([creada])
  @@map("notificacion")
}

// ============================================
// SESIONES DE USUARIO
// ============================================

model Sesion {
  id           String  @id @default(uuid()) @db.Uuid
  usuarioId    String  @map("usuario_id") @db.Uuid
  token        String  @unique // JWT Token completo
  jti          String  @unique // Token ID único (del payload)
  refreshToken String? @unique @map("refresh_token") // Para renovar sesión

  // Metadata del dispositivo/navegador
  userAgent   String? @map("user_agent") @db.Text
  ip          String?
  dispositivo String? // "web", "mobile", "desktop"
  navegador   String? // "Chrome", "Firefox", etc

  // Control de expiración
  expiraEn        DateTime @map("expira_en") // Cuándo expira el access_token
  refreshExpiraEn DateTime @map("refresh_expira_en") // Cuándo expira el refresh_token

  // Estado de la sesión
  activa       Boolean  @default(true)
  ultimoAcceso DateTime @default(now()) @map("ultimo_acceso")

  // Timestamps
  creado      DateTime @default(now())
  actualizado DateTime @default(now()) @updatedAt

  // Relación
  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([jti])
  @@index([activa])
  @@index([expiraEn])
  @@map("sesion")
}
